import telebot
import sqlite3
import datetime
import requests
import subprocess
import csv
from flask import Flask, request, jsonify
from telebot import types

TOKEN = "7957786141:AAG454kaD5Jda96CFrNmQTA7RO1tm5zqTjU"
CRYPTO_PAY_API = "345300:AA4rP6kGmNp4WyySncQGtWEeavg4GWD6QTZ"
OWNER_ID =  6331422352  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
SHADOWSOCKS_CONFIG = "/etc/shadowsocks/config.json"

bot = telebot.TeleBot(TOKEN)
app = Flask(__name__)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
def get_db_connection():
    return sqlite3.connect("vpn_users.db", check_same_thread=False)

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
conn = get_db_connection()
cursor = conn.cursor()
cursor.execute('''CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY, 
    start_date TEXT, 
    end_date TEXT, 
    subscribed INTEGER DEFAULT 0,
    ss_port INTEGER UNIQUE
)''')
conn.commit()
conn.close()

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Ä—Ç–∞ –¥–ª—è Shadowsocks
def generate_ss_port():
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT MAX(ss_port) FROM users")
    last_port = cursor.fetchone()[0]
    conn.close()
    return (last_port + 1) if last_port else 8388  # –ù–∞—á–Ω–µ–º —Å –ø–æ—Ä—Ç–∞ 8388

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Shadowsocks
def add_shadowsocks_user(user_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    ss_port = generate_ss_port()
    cursor.execute("UPDATE users SET ss_port = ? WHERE user_id = ?", (ss_port, user_id))
    conn.commit()
    conn.close()
    with open(SHADOWSOCKS_CONFIG, "a") as config_file:
        config_file.write(f'{{"server_port": {ss_port}, "password": "vpn{user_id}"}}\n')
    subprocess.run(["systemctl", "restart", "shadowsocks-libev"])
    return ss_port

# –ö–æ–º–∞–Ω–¥–∞ /start
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.chat.id
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()
    
    if not user:
        start_date = datetime.datetime.now()
        end_date = start_date + datetime.timedelta(days=3)  # –ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥
        cursor.execute("INSERT INTO users (user_id, start_date, end_date, subscribed) VALUES (?, ?, ?, 0)", 
                       (user_id, start_date, end_date))
        conn.commit()
        bot.send_message(user_id, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–∞–º –¥–æ—Å—Ç—É–ø–µ–Ω 3-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥.")
    else:
        bot.send_message(user_id, "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∫–æ–º–∞–Ω–¥–æ–π /status")
    conn.close()

# –ö–æ–º–∞–Ω–¥–∞ /status
@bot.message_handler(commands=['status'])
def status(message):
    user_id = message.chat.id
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT end_date, subscribed, ss_port FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()
    conn.close()
    
    if not user:
        bot.send_message(user_id, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.")
        return
    
    end_date = datetime.datetime.strptime(user[0], "%Y-%m-%d %H:%M:%S.%f")
    subscribed = user[1]
    ss_port = user[2]
    
    if subscribed:
        bot.send_message(user_id, f"–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ {end_date.strftime('%Y-%m-%d')}.")
    elif datetime.datetime.now() > end_date:
        bot.send_message(user_id, "–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞! –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∫–æ–º–∞–Ω–¥–æ–π /buy.")
    else:
        bot.send_message(user_id, f"–í–∞—à –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∞–∫—Ç–∏–≤–µ–Ω –¥–æ {end_date.strftime('%Y-%m-%d')}.")

# –ö–æ–º–∞–Ω–¥–∞ /get_ss –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö Shadowsocks
@bot.message_handler(commands=['get_ss'])
def get_ss(message):
    user_id = message.chat.id
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT subscribed, ss_port FROM users WHERE user_id = ?", (user_id,))
    user = cursor.fetchone()
    conn.close()
    
    if not user:
        bot.send_message(user_id, "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start.")
        return
    
    subscribed, ss_port = user
    
    if not subscribed:
        bot.send_message(user_id, "–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å –∫–æ–º–∞–Ω–¥–æ–π /buy.")
    elif ss_port:
        bot.send_message(user_id, f"–í–∞—à Shadowsocks –¥–æ—Å—Ç—É–ø:\n–ü–æ—Ä—Ç: {ss_port}\n–ü–∞—Ä–æ–ª—å: vpn{user_id}")
    else:
        bot.send_message(user_id, "–í–∞—à Shadowsocks –µ—â–µ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")

# –û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ CryptoBot
@bot.message_handler(commands=['buy_crypto'])
def buy_crypto(message):
    user_id = message.chat.id
    invoice = create_crypto_invoice(user_id)
    bot.send_message(user_id, f"–û–ø–ª–∞—Ç–∏—Ç–µ —á–µ—Ä–µ–∑ CryptoBot: {invoice}")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ CryptoBot
def create_crypto_invoice(user_id):
    url = "https://pay.crypt.bot/api/createInvoice"
    headers = {"Crypto-Pay-API-Token": CRYPTO_PAY_API}
    data = {"asset": "USDT", "amount": 2.5, "description": "VPN –ø–æ–¥–ø–∏—Å–∫–∞", "hidden_message": str(user_id)}
    response = requests.post(url, headers=headers, json=data).json()
    return response['result']['pay_url'] if response['ok'] else "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞"

# –í—ã–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)
@bot.message_handler(commands=['export_db'])
def export_db(message):
    if message.chat.id != OWNER_ID:
        bot.send_message(message.chat.id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
        return

    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users")
    users = cursor.fetchall()
    conn.close()

    file_path = "/tmp/users.csv"
    with open(file_path, mode="w", newline="", encoding="utf-8") as file:
        writer = csv.writer(file)
        writer.writerow(["user_id", "start_date", "end_date", "subscribed", "ss_port"])
        writer.writerows(users)

    with open(file_path, "rb") as file:
        bot.send_document(OWNER_ID, file, caption="üìÇ –≠–∫—Å–ø–æ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == '__main__':
    bot.polling(none_stop=True)
    app.run(host='0.0.0.0', port=5000)

